#!/bin/bash

function show_help() {
	echo "usage: $0 <bot amount> [port] [chat file]"
	echo "description:"
	echo "  creates <bot amount> penetration bots"
	echo "  and sends them to localhost:port (default 8303)"
	echo "env:"
	echo "  SERVER_IP       server ip to be used instead of localhost"
	echo "  SERVER_PW       server password"
}

if [ "$#" -eq 0 ] || [ "$1" == "--help" ] || [ "$1" == "-h" ]
then
	show_help
	exit
fi

if [ ! -d ./src ]
then
	echo "Error: source folder not found"
	echo "make sure to execute the script from root of repo"
	exit 1
fi

build_dir=headless

if [ ! -f ./"$build_dir"/chillerbot-ux ]
then
	mkdir -p "$build_dir"
	cd "$build_dir" || exit 1
	cmake .. -DHEADLESS_CLIENT=ON
	make -j"$(nproc)"
	cd ..
fi

arg_num=$1
arg_port=8303
arg_file=pentest.txt
arg_ip="${SERVER_IP:-localhost}"
arg_password="${SERVER_PW:-test}"

if [ $# -gt 1 ]
then
	arg_port=$2
fi
if [ $# -gt 2 ]
then
	arg_file=$3
fi

re='^[0-9]+$'
if ! [[ $arg_num =~ $re ]]
then
	echo "Error: first argument is not a number '$arg_num'" >&2
	exit 1
fi
if ! [[ $arg_port =~ $re ]]
then
	echo "Error: second argument is not a number '$arg_port'" >&2
	exit 1
fi

if [ ! -f "$arg_file" ]
then
	echo "Error: chat file '$arg_file' not found."
	echo "Do you want to create it? [y/N]"
	read -r -n 1 yn
	echo ""
	if [[ "$yn" =~ [yY] ]]
	then
		vim "$arg_file"
	else
		echo "aborting due to missing file..."
		exit 1
	fi
fi

echo "starting bots on port: $arg_port"
echo "use ./stop_pentest.sh to stop them"
for (( i=0; i<arg_num; i++ ))
do
	printf "."
	./"$build_dir"/chillerbot-ux "cl_pentest 1;cl_pentest_file $arg_file;password $arg_password;connect $arg_ip:$arg_port" >/dev/null 2>&1 &
	sleep 0.5
done

echo ""
echo "finished starting $arg_num pentest bots."

